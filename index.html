<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Electro-Shock M.5 (Multiplayer)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
:root{
  --bg: #0b0b0d;
  --panel: #1a1a20;
  --accent: #00e5ff;
  --accent-2: #6fffb0;
  --warn: #ffb86b;
  --danger: #ff4d4f;
  --grid-count: 11;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  background: linear-gradient(180deg, #05050a 0%, #0b0b0d 100%);
  color: #e6f7ff;
  font-family: 'Kanit', sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  padding: 10px;
  overflow-x: hidden;
}

/* --- SETUP SCREEN (New) --- */
#setupOverlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(5,5,10,0.95);
  z-index: 3000;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  backdrop-filter: blur(10px);
  transition: opacity 0.5s;
}
#setupOverlay.hidden { opacity: 0; pointer-events: none; }
.player-select-btn {
  background: #222; border: 2px solid #444; color: #fff;
  width: 50px; height: 50px; border-radius: 50%;
  font-size: 1.2rem; margin: 5px; cursor: pointer; transition: 0.2s;
}
.player-select-btn.selected {
  background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 15px var(--accent); transform: scale(1.1);
}
.start-btn {
  margin-top: 30px; padding: 15px 40px; font-size: 1.5rem;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  border: none; border-radius: 50px; color: #000; font-weight: 800;
  cursor: pointer; box-shadow: 0 5px 20px rgba(0,229,255,0.4);
  animation: pulseBtn 2s infinite;
}
@keyframes pulseBtn { 0% {transform:scale(1);} 50% {transform:scale(1.05);} 100% {transform:scale(1);} }

/* --- GAME UI --- */
.controls {
  display: flex; gap: 10px; align-items: center; justify-content: center;
  margin-bottom: 15px; flex-wrap: wrap; width: 100%; max-width: 600px;
}

#gameWrap {
  display: flex; gap: 20px; align-items: flex-start; justify-content: center;
  width: 100%; max-width: 1200px;
}

/* --- BOARD --- */
.board {
  display: grid;
  grid-template-columns: repeat(var(--grid-count), 1fr);
  grid-template-rows: repeat(var(--grid-count), 1fr);
  width: 100%; max-width: 650px; aspect-ratio: 1 / 1;
  background: #15151a; border-radius: 8px; padding: 1%;
  box-shadow: 0 5px 20px rgba(0,0,0,0.5); position: relative; margin: 0 auto;
}

.center-area {
  grid-column: 2 / span 9; grid-row: 2 / span 9;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.02); border: 1px dashed rgba(255,255,255,0.1); border-radius: 8px;
}
.card-stack { font-size: clamp(2rem, 8vw, 4rem); color: rgba(0,229,255,0.2); animation: pulse 2s infinite; }

.tile {
  position: relative; border: 1px solid rgba(255,255,255,0.05);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  overflow: hidden; cursor: pointer; background: rgba(255,255,255,0.01); border-radius: 4px;
}
.tile.start { border: 1px solid var(--accent-2); background: rgba(111,255,176,0.05); }
.tile.trap { background: rgba(255,77,79,0.1); border-color: rgba(255,77,79,0.3); }
.tile.bonus { background: rgba(250,219,20,0.05); border-color: rgba(250,219,20,0.3); }

.tile .idx { position: absolute; top: 1px; left: 2px; font-size: 8px; opacity: 0.5; }
.tile i { font-size: clamp(10px, 2.5vw, 16px); margin-bottom: 2px; }
.tile .title { font-size: 9px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 95%; }

/* --- TOKENS --- */
.token {
  position: absolute; width: 2.8%; height: 2.8%;
  min-width: 12px; min-height: 12px; max-width: 22px; max-height: 22px;
  border-radius: 50%; border: 2px solid #fff; z-index: 50;
  box-shadow: 0 2px 4px rgba(0,0,0,0.8);
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: bold; color: #000;
  transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.t1{background:#ff4d4f;color:#fff} /* Red */
.t2{background:#00e5ff;} /* Cyan */
.t3{background:#fadb14;} /* Yellow */
.t4{background:#52c41a;color:#fff} /* Green */
.t5{background:#d32f2f;color:#fff; border-color:#ff80ab; background: magenta;} /* Magenta (New) */

/* --- SIDE PANEL --- */
.sidePanel {
  width: 100%; max-width: 350px; background: var(--panel); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);
}
.scoreTable { width: 100%; border-collapse: collapse; font-size: 14px; }
.scoreTable th, .scoreTable td { padding: 8px 5px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }

/* --- MISC --- */
button { background: var(--accent); color: #000; border: none; padding: 10px 18px; border-radius: 50px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
button:disabled { background: #333; color: #777; }
.dice-display { font-size: 24px; width: 40px; height: 40px; background: #222; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--warn); }
.alert-toast{ position: fixed; top: 70px; right: 20px; background: #222; border-left: 4px solid var(--accent); color: #fff; padding: 12px 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transform: translateX(150%); transition: transform 0.3s ease-out; z-index: 2000; max-width: 80%; }
.alert-toast.show { transform: translateX(0); }

@media (max-width: 900px) { #gameWrap { flex-direction: column; align-items: center; } .sidePanel { width: 100%; max-width: 650px; } }
@media (max-width: 600px) { .tile .idx, .tile .title { display: none; } .tile i { font-size: 14px; } .board { width: 98vw; height: 98vw; padding: 2px; } .controls { position: sticky; top: 0; background: rgba(11,11,13,0.95); z-index: 100; padding: 10px; border-bottom: 1px solid #333; } }
@keyframes pulse { 0% { transform: scale(1); opacity:0.2; } 50% { transform: scale(1.1); opacity:0.5; } 100% { transform: scale(1); opacity:0.2; } }

/* Editor & Swal Overrides */
.editor-item { background: #2b2b36; padding: 10px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; border: 1px solid #333; }
.swal2-popup { background: #1a1a20 !important; border: 1px solid #333; font-size: 0.9rem !important; color:#fff !important; }
.swal2-title, .swal2-content { color: #fff !important; }
.swal2-input, .swal2-select { background: #0b0b0d !important; color: #fff !important; border-color: #444 !important; }
</style>
</head>
<body>

<div id="setupOverlay">
  <h1 style="font-size: 2.5rem; margin-bottom: 20px; color: var(--accent);"><i class="fas fa-bolt"></i> Electro-Shock</h1>
  <p style="margin-bottom: 10px; color: #aaa;">เลือกจำนวนผู้เล่น</p>
  <div style="display: flex; gap: 10px;">
    <button class="player-select-btn" onclick="selectPlayerCount(1)">1</button>
    <button class="player-select-btn" onclick="selectPlayerCount(2)">2</button>
    <button class="player-select-btn" onclick="selectPlayerCount(3)">3</button>
    <button class="player-select-btn selected" onclick="selectPlayerCount(4)">4</button>
    <button class="player-select-btn" onclick="selectPlayerCount(5)">5</button>
  </div>
  <button class="start-btn" onclick="finishSetup()">เริ่มเกม!</button>
</div>

<div class="controls">
  <button id="setupBtn" class="secondary" style="padding: 8px 12px;"><i class="fas fa-cog"></i></button>
  <button id="rollBtn" disabled>ทอยเต๋า!</button>
  <div class="dice-display" id="diceDisplay"><i class="fas fa-question"></i></div>
  <div id="turnDisplay" style="font-size:14px; font-weight:bold;"></div>
</div>

<div id="gameWrap">
  <div class="board" id="board"></div>
  <div class="sidePanel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span style="font-weight:bold; color:#ccc;"><i class="fas fa-list"></i> คะแนน</span>
        <button id="resetBtn" style="padding:4px 10px; font-size:11px; background:var(--danger)">เริ่มใหม่</button>
    </div>
    <table class="scoreTable" id="scoreTable">
        <thead><tr><th>ผู้เล่น</th><th>ช่อง</th><th>คะแนน</th><th>การ์ด</th></tr></thead>
        <tbody></tbody>
    </table>
  </div>
</div>

<div class="alert-toast" id="toast">แจ้งเตือน</div>

<script>
// --- CONFIG & STATE ---
const GRID = 11;
const PERIM = (GRID-1)*4; 
let PLAYERS_COUNT = 4; // Default, changed by setup
let players = [];
let currentPlayer = 0;
let isMoving = false;

// Default Questions
let questionPool = [
  { text: "หน่วยของประจุไฟฟ้าคือ?", type: "mc", choices: ["แอมแปร์", "คูลอมบ์", "โวลต์", "โอห์ม"], correct: 1, points: 10, time: 5 },
  { text: "ประจุชนิดเดียวกันจะ?", type: "mc", choices: ["ดูดกัน", "ผลักกัน", "เฉยๆ", "หมุน"], correct: 1, points: 10, time: 10 },
  { text: "สูตรกฎของคูลอมบ์?", type: "mc", choices: ["F=ma", "F=kq1q2/r²", "E=F/q", "V=IR"], correct: 1, points: 20, time: 10 },
  { text: "สนามไฟฟ้าในตัวนำทรงกลม?", type: "mc", choices: ["มากสุด", "เท่าผิว", "เป็นศูนย์", "หาไม่ได้"], correct: 2, points: 20, time: 20 },
  { text: "ประจุไฟฟ้าของอิเล็กตรอนอิสระมีค่ากี่คูลอมบ์", type: "mc", choices: ["1.6 × 10⁻¹⁹ C", "1.6 × 10¹⁹  C", "16 × 10¹⁹   C", "16 × 10⁻¹⁹  C"], correct: 0, points: 20, time: 15 },
  { text: "ชนิดประจุไฟฟ้าเกิดแรงระหว่างประจุอย่างไร?", type: "mc", choices: ["(+,+) ดูด, (-,-) ผลัก", " (+,-) ผลัก, (-,+) ผลัก", " (+,+) ผลัก, (-,-) ดูด", " (+,-) ดูด, (-,+) ดูด"], correct: 3, points: 10, time: 10 },
  { text: "ข้อใดไม่ใช่ฉนวนไฟฟ้า", type: "mc", choices: ["ไม้", "พลาสติก", "ผ้า", "เงิน"], correct: 3, points: 15, time: 5 },
  { text: "ค่าคงที่คูลอมบ์มีค่าเท่าใด", type: "mc", choices: ["1.6 × 10⁻¹⁹", "9 × 10⁹", "1.6 × 10¹⁹", ".9 × 10⁻⁹"], correct: 1, points: 20, time: 15 },
  { text: "วงจรไฟฟ้าหนึ่งประกอบไปด้วยตัวเก็บประจุที่มีความต่างศักย์ C1 เท่ากับ4 v และ C2 เท่ากับ 2 v ที่มีความจุ C และ 2C ตามลำดับ ต่อเข้ากับแบตเตอรี่ขนาด 6 โวลต์ จงหาพลังงานไฟฟ้าที่สะสมใน C2 หน่วยไมโครจูล", type: "mc", choices: ["24", "12", "42", "21"], correct: 0, points: 50, time: 200 },
  { text: "ความแตกต่างของไฟฟ้ากระแสตรง กับ ไฟฟ้ากระแสสลับ", type: "mc", choices: ["ทิศทางของกระแสไฟฟ้า", "ไม่แตกต่าง", "ความเร็วกระแสไฟฟ้า", "พลังงานไฟฟ้า"], correct: 0, points: 20, time: 10 },
  { text: "ตัวต้านทานตัวหนึ่ง มีแถบสี 4 แถบ ดังนี้้ 1=น้ำตาล,2=ดำ,3=ดำ,4=ทอง ตัวต้านทานนี้อยู่ในช่วงเท่าใด", type: "mc", choices: [" [9.0,11.5]", "[9.5,10.5]", "[9.5,11.5]", "[9.0,11.5]"], correct: 1, points: 30, time: 200 },
  { text: "ลวดตัวนำหนึ่งมีกระแสไฟฟ้าไหลผ่าน 0.4 แอมแปร์ เมื่อเวลาผ่านไป 10 นาที มีปริมาณประจุไฟฟ้าเท่าใด", type: "mc", choices: ["210 C", "220 C", "230 C", "240 C"], correct: 3, points: 50, time: 200 },
  { text: "ลวดโลหะเส้นหนึ่งมีจำนวนอิเล็กตรอนอิสระ 5.0x10²⁸ อนุภาคต่อลูกบาศก์เมตรและมีขนาดพื้นที่ภาคตัดขวาง 2.0 ตารางมิลลิเมตร ถ้าความเร็วเฉลี่ยของอิเล็กตรอนผ่านลวดนี้ 0.19 มิลลิเมตรต่อวินาทีจำนวนอิเล็กตรอนอิสระที่ผ่านเส้นลวดในเวลา 1 นาทีมีค่าเท่าไร", type: "mc", choices: ["1.14 × 10²¹", "1.44 × 10²⁰", "1.14 × 10²⁰", "1.44 × 10²¹"], correct: 0, points: 100, time: 200 },
  { text: "ตัวน้ำรูปทรงกลม A และ B มีรัศมีของทรงกลมเป็น r และ 2r ตามลำดับ ถ้านำตัวนำ A มีประจุQ และตัวนำ B มีประจุ -2Q เมื่อเอามาแตะกันแล้วแยกออก จงหาประจุตัวนำ A", type: "mc", choices: ["-Q", "-Q/2", "-Q/3", "Q/3"], correct: 2, points: 100, time: 200 },
  { text: "ถ้าเพิ่มระยะห่างระหว่างประจุไฟฟ้า 2 จุด เป็น 2 เท่า แรงระหว่างประจุจะเป็นอย่างไรตามกฎของคูลอมบ์", type: "mc", choices: ["เพิ่มขึ้นสองเท่า", "เท่าเดิม", "ลดลงเหลือ1/4", "ลดลงเหลือ1/2"], correct: 1, points: 100, time: 200 },
  { text: " เส้นแรงไฟฟ้า(Electric Field Lines) มีทิศทางตามข้อใด?", type: "mc", choices: ["พุ่งออกจากประจุบวก เข้าหาประจุลบ", "พุ่งออกจากประจุลบ เข้าหาประจุบวก", "วนรอบประจุบวกตามเข็มนาฬิกา", "วนรอบประจุลบทวนเข็มนาฬิกา"], correct: 0, points: 20, time: 20 },
  { text: "สูตรกฎของคูลอมบ์?", type: "mc", choices: ["F=ma", "F=kq1q2/r^2", "E=F/q", "V=IR"], correct: 1, points: 20, time: 10 },
  { text: "สนามไฟฟ้าในตัวนำทรงกลม?", type: "mc", choices: ["มากสุด", "เท่าผิว", "เป็นศูนย์", "หาไม่ได้"], correct: 2, points: 20, time: 20 },
  { text: "ลวดตัวนำเส้นหนึ่งมีความต้านทาน R หากนำมายืดออกให้ยาวเป็น 2 เท่าของความยาวเดิม(โดยปริมาตรคงที่) ความต้านทานใหม่จะเป็นกี่เท่าของเดิม?", type: "mc", choices: ["4R", "8R", "R", "2R"], correct: 0, points: 100, time: 200 },
  { text: "ข้อใดกล่าวถูกต้องเกี่ยวกับกระแสไฟฟ้าในตัวนำโลหะ?", type: "mc", choices: ["กระแสไฟฟ้าคือการเคลื่อนที่ของโปรตอน", ".หน่วยของกระแสไฟฟ้าคือ คูลอมบ์(Coulomb)", "กระแสไฟฟ้าไหลจากศักย์สูงไปศักย์ต่ำเสมอ", "กระแสไฟฟ้าไหลทิศเดียวกับการเคลื่อนที่ของอิเล็กตรอนอิสระ"], correct: 2, points: 10, time: 30 },
  { text: "ข้อใดกล่าวถูกต้องเมื่อนำผ้าขนสัตว์ถูกับแท่งแก้ว", type: "mc", choices: ["ดูดวัตถุเบาๆได้", "ขาดอิเล็กตรอน", "มีประจุไฟฟ้าบวก", "มีประจุไฟฟ้าเป็นกลาง"], correct: 0, points: 15, time: 20},
  { text: "หลอดไฟ 2 หลอด ต่อ 'อนุกรม' กัน หลอด A มีความต้านทานมาก หลอด B มีความต้านทานน้อย หลอดใดจะสว่างกว่า?", type: "mc", choices: ["หลอด A สว่างกว่า", "สรุปไม่ได้", "หลอด B สว่างกว่า", "สว่างเท่ากัน"], correct: 0, points: 20, time: 30 },
  { text: "ข้อใดกล่าวถึงวัตถุที่มีประจุไฟฟ้าเป็นบวกได้ถูกต้อง", type: "mc", choices: ["สูญเสียอิเล็กตรอน", "อิเล็กตรอนมีประจุเป็นบวก", "นิวเคลียสมีประจุไฟฟ้าบวก", "วัตถุที่มีอิเล็กตรอนมากกว่าปกติ "], correct: 0, points: 10, time: 15 },
  { text: "วัตถุที่ต่อสายดินไว้จะมีประจุไฟฟ้าเป็นอย่างไร", type: "mc", choices: ["เป็นบวก", "เป็นลบ", "เป็นกลาง", "ไม่มีประจุชนิดใดเลย"], correct: 2, points: 20, time: 15 },
  { text: "ข้อใดไม่เป็นปริมาณเวกเตอร์", type: "mc", choices: ["ประจุไฟฟ้า", "ศักย์ไฟฟ้า", "พลังงานไฟฟ้า", "สนามไฟฟ้า"], correct: 1, points: 10, time: 5},
  { text: "วัตถุ A มีประจุ -8.0 x 10⁻³ ไมโครคูลอมบ์ แสดงว่า วัตถุ A มีการรับอิเล็กตรอนหรือให้โปรตอนไปกี่อนุภาค", type: "mc", choices: ["5x10⁹", "5x10¹⁰", "5x10¹¹", "5x10¹²"], correct: 1, points: 100, time: 200 },
  { text: "สนามไฟฟ้าที่ระยะห่าง 10 cm จากอนุภาคที่อยู่โดดเดี่ยวซึ่งมีประจุเป็น 2x10⁻⁹ C มีค่าเป็นเท่าไร", type: "mc", choices: ["1.8 N/C", "18 N/C", "180 N/C", "1800 N/C"], correct: 3, points: 50, time: 200 },
  { text: "เมื่อวางลูกพิธที่มีประจุไฟฟ้าห่างกัน 4 เซนติเมตร ปรากฏว่ามีแรงกระทำต่อกัน 10⁻⁴ N ถ้าวางลูกพิททั้งสองห่างกัน 8 เซนติเมตร จะมีแรงกระทำระหว่างกันเท่าใด", type: "mc", choices: ["2.5 x 10⁻⁵ N", "6.5 x 10⁻⁵ N", "2.5 x 10⁻⁶ N", "6.5 x 10⁻⁶ N"], correct: 0, points: 75, time: 200 },
  { text: "A และ B เป็นตัวนำทรงกลม รัศมีของ B เป็น 2 เท่าของ A ถ้าให้ประจุแก่ตัวนำทั้งสองเท่ากัน ศักย์ไฟฟ้าบน A จะเป็นกี่เท่าของ B", type: "mc", choices: ["1/4", "1/2", "2", "4"], correct: 1, points: 100, time: 200 },
  { text: "เมื่อนำประจุบวกมาไว้ใกล้ประจุลบจะเกิดแรงใด", type: "mc", choices: ["แรงผลัก", "แรงดูด", "แรงลัพธ์", "แรงเหวี่ยง"], correct: 1, points: 10, time: 5 },
  { text: "อุปกรณ์ใดที่ใช้ป้องกันไฟฟ้ารั่ว", type: "mc", choices: ["การต่อสายดิน", "การต่อสายล่อฟ้า", "เครื่องส่งสัญญาณ", "สายฉนวน"], correct: 0, points: 15, time: 10 },
  { text: "แท่งแก้วอันหนึ่งสูญเสียอิเล็กตรอนไป 10⁴ อิเล็กตรอน แท่งแก้วมีประจุไฟฟ้าเท่าใด", type: "mc", choices: ["1.6 × 10⁻¹³ C", "1.6 × 10⁻¹⁴ C", "1.6 × 10⁻¹⁵ C", "1.6 × 10⁻¹⁶ C"], correct: 2, points: 50, time: 200 },
  { text: "มวลของอิเล้กตรอนมีกี่กิโลกรัม", type: "mc", choices: ["9 × 10⁻³¹", "1.6 × 10⁻¹⁹", "9 × 10⁹", "1.6 × 10⁻²²"], correct: 1, points: 10, time: 10 }
];

const specialCards = [
    { name: "Super Charge", effect: "score", val: 50, desc: "+50 คะแนน" },
    { name: "Short Circuit", effect: "score", val: -20, desc: "-20 คะแนน" },
    { name: "Warp Speed", effect: "move", val: 5, desc: "เดินหน้า 5 ช่อง" },
    { name: "Magnetic Pull", effect: "move", val: -3, desc: "ถอยหลัง 3 ช่อง" }
];

// Board Layout
const boardLayout = {};
const layoutTypes = [
    {idx:0, type:'start', label:'START', icon:'fa-flag', color:'#6fffb0'},
    {idx:5, type:'bonus', label:'Bonus', val:20, icon:'fa-star', color:'#fadb14'},
    {idx:9, type:'card', label:'CARD', icon:'fa-bolt', color:'#bc13fe'},
    {idx:12, type:'trap', label:'Trap', val:-15, icon:'fa-exclamation-triangle', color:'#ff4d4f'},
    {idx:17, type:'move', label:'Warp', val:4, icon:'fa-forward', color:'#00e5ff'},
    {idx:20, type:'trap', label:'Leak', val:-10, icon:'fa-tint', color:'#ff4d4f'},
    {idx:25, type:'card', label:'CARD', icon:'fa-bolt', color:'#bc13fe'},
    {idx:30, type:'move', label:'Back', val:-3, icon:'fa-backward', color:'#ff4d4f'},
    {idx:34, type:'bonus', label:'BigBonus', val:40, icon:'fa-gem', color:'#fadb14'},
    {idx:38, type:'card', label:'CARD', icon:'fa-bolt', color:'#bc13fe'}
];

// --- SETUP FUNCTIONS ---
function selectPlayerCount(n) {
    PLAYERS_COUNT = n;
    document.querySelectorAll('.player-select-btn').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('.player-select-btn')[n-1].classList.add('selected');
}

function finishSetup() {
    document.getElementById('setupOverlay').classList.add('hidden');
    resetGame();
}

function showSetup() {
    document.getElementById('setupOverlay').classList.remove('hidden');
}

// --- INIT GAME ---
function init() {
    layoutTypes.forEach(l => boardLayout[l.idx] = l);
    createBoard();
    // Don't call resetGame here, wait for setup
    
    document.getElementById('rollBtn').addEventListener('click', rollDice);
    document.getElementById('resetBtn').addEventListener('click', () => {
        Swal.fire({
            title:'ต้องการรีเซ็ต?', 
            text:'จะกลับไปหน้าเลือกผู้เล่น', 
            icon:'warning', 
            showCancelButton:true, 
            confirmButtonText:'ใช่, เริ่มใหม่', 
            cancelButtonText:'ยกเลิก'
        }).then(r=>{ if(r.isConfirmed) showSetup(); });
    });
    document.getElementById('setupBtn').addEventListener('click', openEditor);
    
    window.addEventListener('resize', () => { setTimeout(renderTokens, 100); });
}

function createBoard() {
    const board = document.getElementById('board');
    board.innerHTML = '';
    const coords = [];
    for(let c=GRID; c>=1; c--) coords.push([c,1]); 
    for(let r=2; r<=GRID-1; r++) coords.push([1,r]); 
    for(let c=1; c<=GRID; c++) coords.push([c,GRID]); 
    for(let r=GRID-1; r>=2; r--) coords.push([GRID,r]); 

    const center = document.createElement('div');
    center.className = 'center-area';
    center.innerHTML = `<div class="card-stack"><i class="fas fa-bolt"></i></div>`;
    board.appendChild(center);

    for(let i=0; i<PERIM; i++) {
        const tile = document.createElement('div');
        tile.id = `tile-${i}`;
        let info = boardLayout[i] || { type:'q', label:`Q`, icon:'fa-question', color:'#fff' };
        tile.className = `tile ${info.type}`;
        tile.style.gridColumn = coords[i][0];
        tile.style.gridRow = coords[i][1];
        tile.innerHTML = `<span class="idx">${i}</span><i class="fas ${info.icon}" style="color:${info.color}"></i><span class="title" style="color:${info.color}">${info.label}</span>`;
        tile.onclick = () => showTileInfo(i);
        board.appendChild(tile);
    }
}

function showTileInfo(i) {
    const info = boardLayout[i] || { label: 'คำถาม', type: 'Question' };
    showToast(`ช่อง ${i}: ${info.label}`);
}

function resetGame() {
    // Clear old tokens
    document.querySelectorAll('.token').forEach(t => t.remove());
    
    players = Array.from({length: PLAYERS_COUNT}, (_, i) => ({ id: i+1, name: `P${i+1}`, pos: 0, score: 0, cards: [] }));
    currentPlayer = 0;
    isMoving = false;
    document.getElementById('rollBtn').disabled = false;
    updateUI();
    renderTokens();
    showToast(`เริ่มเกม ${PLAYERS_COUNT} คน!`);
}

function rollDice() {
    if(isMoving) return;
    isMoving = true;
    document.getElementById('rollBtn').disabled = true;
    
    const diceEl = document.getElementById('diceDisplay');
    let roll, count=0;
    const interval = setInterval(() => {
        roll = Math.floor(Math.random()*6)+1;
        diceEl.innerHTML = `<i class="fas fa-dice-${['one','two','three','four','five','six'][roll-1]}"></i>`;
        if(++count > 10) { clearInterval(interval); movePlayer(roll); }
    }, 80);
}

function movePlayer(steps) {
    const p = players[currentPlayer];
    let remaining = Math.abs(steps);
    let dir = steps > 0 ? 1 : -1;
    
    const iv = setInterval(() => {
        if(remaining <= 0) { clearInterval(iv); handleLanding(p); return; }
        p.pos = (p.pos + dir + PERIM) % PERIM;
        if(p.pos===0 && dir>0 && remaining>1) { p.score+=20; showToast("ผ่าน Start +20"); }
        renderTokens();
        remaining--;
    }, 200);
}

function handleLanding(p) {
    const info = boardLayout[p.pos] || { type: 'q' };
    if(info.type === 'start') endTurn();
    else if(info.type === 'q') askQuestion(p);
    else if(info.type === 'trap' || info.type === 'bonus') {
        p.score += info.val;
        showToast(`${info.label}: ${info.val > 0 ? '+' : ''}${info.val}`);
        endTurn();
    }
    else if(info.type === 'move') { showToast("Warp!"); setTimeout(()=>movePlayer(info.val), 800); }
    else if(info.type === 'card') askQuestion(p, true);
    updateUI();
}

function askQuestion(p, isCard=false) {
    if(questionPool.length===0) { endTurn(); return; }
    const q = questionPool[Math.floor(Math.random()*questionPool.length)];
    let idxs = [0,1,2,3].sort(()=>Math.random()-0.5);
    let html = idxs.map(i => `<label style="display:flex;align-items:center;background:#333;padding:12px;margin:6px 0;border-radius:6px;cursor:pointer;"><input type="radio" name="ans" value="${i}" style="margin-right:10px;transform:scale(1.2);"><span style="font-size:1rem;">${q.choices[i]}</span></label>`).join('');

    let timerVal = q.time;
    let timerIv;
    Swal.fire({
        title: isCard ? 'ชิงการ์ด!' : 'คำถาม',
        html: `<p style="font-size:1.1rem; color:var(--accent); margin-bottom:10px;">${q.text}</p><div style="text-align:left">${html}</div><div style="margin-top:10px; color:var(--warn)">เวลา: <span id="qt">${timerVal}</span>s</div>`,
        confirmButtonText: 'ตอบ',
        allowOutsideClick: false,
        didOpen: () => {
            timerIv = setInterval(() => {
                timerVal--;
                const el = document.getElementById('qt'); if(el) el.innerText = timerVal;
                if(timerVal<=0) Swal.clickConfirm();
            }, 1000);
        },
        preConfirm: () => {
            const el = document.querySelector('input[name="ans"]:checked'); return el ? parseInt(el.value) : null;
        }
    }).then(res => {
        clearInterval(timerIv);
        const ans = res.value;
        if(ans === q.correct) {
            Swal.fire({icon:'success', title:'ถูกต้อง!', timer:1000, showConfirmButton:false});
            if(isCard) setTimeout(()=>drawCard(p), 1000);
            else { p.score += q.points; showToast(`ถูกต้อง +${q.points}`); endTurn(); }
        } else {
            Swal.fire({icon:'error', title:'ผิด!', text: `เฉลย: ${q.choices[q.correct]}`, timer:2000, showConfirmButton:false});
            if(!isCard) { p.score = Math.max(0, p.score-5); showToast("ผิด -5"); }
            endTurn();
        }
        updateUI();
    });
}

function drawCard(p) {
    const card = specialCards[Math.floor(Math.random()*specialCards.length)];
    Swal.fire({
        title: card.name, html: `<i class="fas fa-bolt" style="font-size:3rem; color:var(--accent)"></i><p>${card.desc}</p>`, confirmButtonText: 'รับ'
    }).then(() => {
        if(card.effect==='score') p.score += card.val;
        else if(card.effect==='move') { movePlayer(card.val); return; }
        endTurn();
    });
}

function endTurn() {
    currentPlayer = (currentPlayer+1)%PLAYERS_COUNT;
    isMoving = false;
    document.getElementById('rollBtn').disabled = false;
    document.getElementById('diceDisplay').innerHTML = '<i class="fas fa-question"></i>';
    updateUI();
}

function renderTokens() {
    players.forEach(p => {
        let t = document.getElementById(`token-${p.id}`);
        if(!t) {
            t = document.createElement('div'); t.id=`token-${p.id}`; t.className=`token t${p.id}`; t.innerText=p.id;
            document.body.appendChild(t);
        }
        
        const tile = document.getElementById(`tile-${p.pos}`);
        if(tile) {
            const rect = tile.getBoundingClientRect();
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            
            const size = Math.min(rect.width, rect.height) * 0.35; 
            t.style.width = `${size}px`; t.style.height = `${size}px`;
            t.style.fontSize = `${size*0.5}px`;

            // Offset Strategy for up to 5 players
            // 1-4: Corners. 5: Center.
            const offsetMap = [
                {x:-0.8, y:-0.8}, // Top Left
                {x:0.8, y:-0.8},  // Top Right
                {x:-0.8, y:0.8},  // Bottom Left
                {x:0.8, y:0.8},   // Bottom Right
                {x:0, y:0}        // Center (Player 5)
            ];
            // If less than 2 players on same spot, center it? No, keep fixed positions for identity.
            
            const off = offsetMap[(p.id-1) % 5];
            const centerX = rect.left + scrollX + rect.width/2;
            const centerY = rect.top + scrollY + rect.height/2;
            
            // Adjust spread distance
            const spread = size * 0.6;
            
            t.style.left = (centerX + (off.x * spread) - size/2) + 'px';
            t.style.top = (centerY + (off.y * spread) - size/2) + 'px';
        }
    });
}

function updateUI() {
    const p = players[currentPlayer];
    const colors = ['#ff4d4f','#00e5ff','#fadb14','#52c41a', '#d32f2f'];
    if(p) document.getElementById('turnDisplay').innerHTML = `ตาของ: <span style="color:${colors[(p.id-1)%5]}">${p.name}</span>`;
    
    const tbody = document.querySelector('#scoreTable tbody');
    tbody.innerHTML = '';
    players.forEach(pl => {
        tbody.innerHTML += `<tr style="${pl.id===currentPlayer+1?'background:rgba(255,255,255,0.1)':''}">
            <td><span class="t${pl.id}" style="display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px;"></span>${pl.name}</td>
            <td>${pl.pos}</td><td>${pl.score}</td><td>${pl.cards.length}</td>
        </tr>`;
    });
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2000);
}

// Simplified Editor
function openEditor() {
    let html = questionPool.map((q,i)=>`<div class="editor-item" onclick="editQ(${i})"><b>${i+1}.</b> ${q.text.substring(0,20)}...</div>`).join('');
    Swal.fire({ title: 'แก้ไขคำถาม', html: `<div style="max-height:200px;overflow-y:auto">${html}</div><button onclick="editQ(-1)" class="swal2-confirm swal2-styled" style="width:100%;margin-top:10px">เพิ่มข้อใหม่</button>`, showConfirmButton:false, showCloseButton:true });
}
window.editQ = (idx) => {
    let q = idx>=0 ? JSON.parse(JSON.stringify(questionPool[idx])) : {text:'',choices:['','','',''],correct:0,points:10,time:20};
    Swal.fire({
        title: idx>=0?'แก้ไข':'เพิ่มใหม่',
        html: `<input id="eq-txt" class="swal2-input" value="${q.text}" placeholder="โจทย์">
               ${[0,1,2,3].map(i=>`<div style="display:flex;align-items:center;margin-top:5px"><input type="radio" name="eq-cor" value="${i}" ${q.correct===i?'checked':''}><input id="eq-c${i}" class="swal2-input" style="height:30px;margin:0 0 0 5px" value="${q.choices[i]}" placeholder="ตัวเลือก ${i+1}"></div>`).join('')}
               <div style="display:flex;gap:5px;margin-top:10px"><input id="eq-pts" type="number" class="swal2-input" value="${q.points}" placeholder="คะแนน"><input id="eq-time" type="number" class="swal2-input" value="${q.time}" placeholder="เวลา"></div>`,
        showDenyButton: idx>=0, denyButtonText:'ลบ', confirmButtonText:'บันทึก',
        preConfirm: () => ({
            text: document.getElementById('eq-txt').value,
            choices: [0,1,2,3].map(i=>document.getElementById('eq-c'+i).value),
            correct: parseInt(document.querySelector('input[name="eq-cor"]:checked')?.value||0),
            points: parseInt(document.getElementById('eq-pts').value),
            time: parseInt(document.getElementById('eq-time').value)
        })
    }).then(r => {
        if(r.isConfirmed) {
            if(!r.value.text) return;
            if(idx>=0) questionPool[idx]=r.value; else questionPool.push(r.value);
            openEditor();
        } else if(r.isDenied) {
            questionPool.splice(idx,1);
            openEditor();
        }
    });
};

init();
</script>
</body>

</html>
